<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <title>Vietri Card Editor</title>

</head>

<body class="overflow-hidden" id="main-ui">
    <div class="flex h-screen">
        <!-- CONTROLS PANEL -->
        <div class="w-1/3 p-6 bg-white border-r border-gray-200 overflow-y-auto shadow-lg z-10 flex flex-col gap-6">
            <div class="flex items-center justify-between border-b pb-4">
                <div class="flex items-center gap-2">
                    <div class="text-3xl">üè∫</div>
                    <div>
                        <h1 class="text-xl font-bold text-blue-900 font-serif leading-none">Vietri</h1>
                        <h2 class="text-sm text-yellow-600 font-bold uppercase tracking-wide">Card Editor</h2>
                    </div>
                </div>
                <a href="index.html"
                    class="bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200 text-sm font-bold flex items-center gap-1 transition-colors">
                    <span>üè†</span> Home
                </a>
            </div>

            <!-- LIBRARY ACTIONS -->
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 shadow-sm">
                <h3 class="font-bold text-blue-800 text-sm uppercase tracking-wider mb-3">Libreria & Stampa</h3>
                <div class="flex gap-2 mb-3">
                    <button onclick="addToLibrary()"
                        class="flex-1 bg-green-600 text-white py-2 rounded font-bold text-sm hover:bg-green-700 shadow flex items-center justify-center gap-1">
                        <span>‚ûï</span> Aggiungi
                    </button>
                    <button onclick="printLibrary()"
                        class="flex-1 bg-gray-800 text-white py-2 rounded font-bold text-sm hover:bg-black shadow flex items-center justify-center gap-1">
                        <span>üñ®Ô∏è</span> Stampa (6/pag)
                    </button>
                </div>
                <!-- Library List -->
                <div id="library-list"
                    class="space-y-2 max-h-40 overflow-y-auto bg-white p-2 rounded border border-gray-200 text-sm">
                    <p class="text-gray-400 text-center text-xs italic">Nessuna carta salvata</p>
                </div>
            </div>

            <!-- EDITOR CONTROLS -->
            <div class="space-y-6">
                <!-- Image Selector -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                    <label class="block font-bold text-gray-700 mb-2 text-sm uppercase tracking-wider">Immagine Opera
                        (.png)</label>
                    <select id="img-select"
                        class="w-full p-2 border rounded bg-white shadow-sm mb-2 focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="preview.png">preview.png</option>
                        <!-- Options populated dynamically -->
                    </select>
                    <input type="text" id="custom-img" placeholder="Nome file custom..."
                        class="w-full p-2 border rounded text-sm bg-white">
                    <p class="text-xs text-gray-400 mt-1">Usa file presenti nella cartella del progetto.</p>

                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <label class="block font-bold text-gray-700 mb-2 text-sm uppercase tracking-wider">Colore Bordo
                            Ceramica</label>
                        <div class="flex items-center gap-2">
                            <input type="color" id="border-color-picker" value="#0047AB"
                                class="h-10 w-full p-1 border rounded cursor-pointer">
                        </div>
                    </div>
                </div>

                <!-- Requirements -->
                <div>
                    <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wider mb-3">Materiali Richiesti</h3>

                    <!-- Fixed Grey -->
                    <div class="flex items-center justify-between mb-2 bg-gray-100 p-2 rounded border border-gray-200">
                        <div class="flex items-center gap-2">
                            <div class="cube cube-gray"></div>
                            <span class="font-bold text-gray-700 text-sm">Base Argilla (1¬∞)</span>
                        </div>
                        <input type="number" id="req-gray" value="1" min="1"
                            class="w-16 p-1 border rounded text-center font-bold">
                    </div>

                    <!-- Dynamic Colors -->
                    <div id="color-reqs-container" class="space-y-2">
                        <!-- JS will populate -->
                    </div>

                    <div class="mt-3 flex gap-2 pt-2 border-t border-dashed">
                        <select id="add-color-select" class="p-2 border rounded text-sm flex-grow bg-white">
                            <option value="red">Rosso</option>
                            <option value="blue">Blu</option>
                            <option value="yellow">Giallo</option>
                            <option value="green">Verde</option>
                            <option value="orange">Arancio</option>
                            <option value="purple">Viola</option>
                        </select>
                        <button onclick="addColorReq()"
                            class="bg-blue-600 text-white px-4 py-1 rounded text-sm font-bold hover:bg-blue-700 shadow-sm transition-colors">+
                            AGGIUNGI</button>
                    </div>
                </div>

                <!-- Reward -->
                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                    <h3 class="font-bold text-yellow-800 text-sm uppercase tracking-wider mb-3">Ricompensa Finale</h3>
                    <div class="flex items-center justify-between">
                        <span class="font-bold text-yellow-600 flex items-center gap-2 text-lg">üí∞ Monete</span>
                        <input type="number" id="reward-coins" value="3" min="0"
                            class="w-20 p-2 border border-yellow-300 rounded text-center font-bold text-xl text-yellow-700 bg-white">
                    </div>
                </div>

                <div class="mt-8">
                    <button onclick="exportConfig()"
                        class="w-full bg-gray-800 text-white py-3 rounded-lg font-bold hover:bg-black shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        Copia JSON Config
                    </button>
                </div>
            </div>
        </div>

        <!-- PREVIEW PANEL -->
        <div
            class="w-2/3 bg-slate-100 flex flex-col items-center justify-center relative bg-[radial-gradient(#e5e7eb_1px,transparent_1px)] [background-size:16px_16px]">

            <div class="mb-4 text-gray-400 font-mono text-sm uppercase tracking-widest">Anteprima 1:1</div>

            <div id="preview-container">
                <!-- Preview rendered here -->
            </div>

            <div class="absolute bottom-6 right-6 text-gray-400 text-xs text-right">
                Vietri Card Editor v1.2<br>
                Cards in Library: <span id="lib-count">0</span>
            </div>

        </div>
    </div>

    <!-- PRINT AREA (Hidden normally) -->
    <div id="print-area" class="hidden"></div>

    <script type="module">
        import './editor.css'; // Import CSS for Vite processing

        // Dynamic Image Loading via Vite
        // This will find all pngs in opere folder and return their public URLs
        const opereImages = import.meta.glob('./opere/*.png', { eager: true, query: '?url', import: 'default' });

        function initImages() {
            const select = document.getElementById('img-select');

            // Sort keys to have consistent order
            Object.keys(opereImages).sort().forEach(path => {
                const url = opereImages[path]; // This is the resolved URL (e.g., /opere/Vaso1.png)
                // Extract filename for display (e.g. Vaso1.png)
                const fileName = path.split('/').pop();

                const option = document.createElement('option');
                option.value = url; // Use the actual URL path
                option.textContent = fileName;
                select.appendChild(option);
            });
        }

        // State
        const state = {
            id: Date.now(),
            img: 'preview.png',
            gray: 1,
            colors: [{ type: 'red', count: 2 }, { type: 'yellow', count: 1 }],
            coins: 3,
            borderColor: '#0047AB'
        };

        // Library State
        let library = [];

        // RENDER HELPERS
        function getReqRowsHTML(gray, colors) {
            let html = '';
            if (gray > 0) html += createReqRow('gray', gray);
            colors.forEach(c => html += createReqRow(c.type, c.count));
            return html;
        }

        function createReqRow(color, count) {
            return `
            <div class="req-row">
                <div class="cube cube-${color}"></div>
                <span class="text-xs text-gray-400 mx-2">x</span>
                <span class="text-xl font-bold font-mono">${count}</span>
            </div>`;
        }

        function getCardHTML(data) {
            // Apply custom border color inline for print preservation
            const maiolicaStyle = `border-color: ${data.borderColor}; background-image: linear-gradient(45deg, ${data.borderColor} 25%, transparent 25%, transparent 75%, ${data.borderColor} 75%, ${data.borderColor}), linear-gradient(45deg, ${data.borderColor} 25%, transparent 25%, transparent 75%, ${data.borderColor} 75%, ${data.borderColor});`;

            return `
            <div class="card-white-border transform transition-all duration-300 hover:scale-[1.02] hover:shadow-2xl">
                <div class="maiolica-border" style="${maiolicaStyle}">
                    <div class="card-inner-box">
                         <!-- LEFT -->
                         <div class="section-left">
                             <div class="text-xs font-bold text-gray-400 uppercase tracking-tight mb-2 text-center w-full">Richiesto</div>
                             <div class="flex flex-col gap-1 w-full pl-2">
                                 ${getReqRowsHTML(data.gray, data.colors)}
                             </div>
                             <div class="mt-auto pt-3 border-t-2 border-dotted border-gray-300 w-full text-center">
                                 <div class="text-[10px] uppercase text-gray-400 font-bold mb-0">Valore</div>
                                 <div class="coin-reward">
                                     <span>${data.coins}</span> <span class="text-2xl">üí∞</span>
                                 </div>
                             </div>
                         </div>
                         <!-- RIGHT -->
                         <div class="section-right">
                             <div class="absolute inset-0 opacity-[0.03]" style="background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIiBmaWxsPSIjMDA0N0FCIj48cGF0aCBkPSJNMjAgMEwyMCA0ME0wIDIwTDQwIDIweiIvPjwvc3ZnPg==')"></div>
                             <img src="${data.img}" class="artwork-img relative z-10 rounded-sm" onerror="this.onerror=null; this.src='https://via.placeholder.com/300?text=IMG+NOT+FOUND';">
                         </div>
                    </div>
                </div>
            </div>`;
        }

        // MAIN RENDER
        function render() {
            // Render Editor List
            const listDiv = document.getElementById('color-reqs-container');
            listDiv.innerHTML = '';
            state.colors.forEach((c, idx) => {
                listDiv.innerHTML += `
                 <div class="flex items-center justify-between mb-2 bg-white p-2 border rounded shadow-sm hover:border-blue-300 transition-colors">
                    <div class="flex items-center gap-2">
                        <div class="cube cube-${c.type}"></div>
                        <span class="capitalize text-sm font-medium text-gray-700">${c.type}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-400">Qt.</span>
                        <input type="number" value="${c.count}" min="1" class="w-12 p-1 border rounded text-center text-sm font-bold" onchange="updateColorCount(${idx}, this.value)">
                        <button onclick="removeColor(${idx})" class="w-6 h-6 flex items-center justify-center rounded-full text-gray-400 hover:text-white hover:bg-red-500 font-bold transition-all ml-1">√ó</button>
                    </div>
                </div>`;
            });

            // Update Input Fields logic...
            document.getElementById('req-gray').value = state.gray;
            document.getElementById('reward-coins').value = state.coins;

            // Update Root Var for Editor Preview
            document.documentElement.style.setProperty('--vietri-blue', state.borderColor);

            // Render Preview Card
            document.getElementById('preview-container').innerHTML = getCardHTML(state);

            // Library Count
            document.getElementById('lib-count').innerText = library.length;
        }

        // LIBRARY FUNCTIONS
        function addToLibrary() {
            // Deep copy state
            const card = JSON.parse(JSON.stringify(state));
            card.id = Date.now();
            library.push(card);
            renderLibraryList();
            // Flash feedback
            const btn = document.querySelector('button[onclick="addToLibrary()"]');
            const old = btn.innerHTML;
            btn.innerHTML = "‚úÖ Salvato!";
            setTimeout(() => btn.innerHTML = old, 1000);
        }

        function removeFromLibrary(idx) {
            library.splice(idx, 1);
            renderLibraryList();
        }

        function loadFromLibrary(idx) {
            const card = library[idx];
            state.img = card.img;
            state.gray = card.gray;
            state.colors = JSON.parse(JSON.stringify(card.colors)); // copy
            state.coins = card.coins;
            state.borderColor = card.borderColor || '#0047AB';

            // Update UI inputs
            const sel = document.getElementById('img-select');
            sel.value = card.img;
            // Fallback if not found in options (though it likely should be)
            if (sel.value !== card.img) {
                // Try force adding it or just fallback
                // For this use case, if the file is gone, fallback to preview
                sel.value = 'preview.png';
            }

            document.getElementById('custom-img').value = card.img;
            document.getElementById('border-color-picker').value = state.borderColor;

            render();
        }

        function renderLibraryList() {
            const el = document.getElementById('library-list');
            if (library.length === 0) {
                el.innerHTML = '<p class="text-gray-400 text-center text-xs italic">Nessuna carta salvata</p>';
                return;
            }
            el.innerHTML = '';
            library.forEach((card, idx) => {
                // Shorten displayed name if it's a path
                const displayName = card.img.split('/').pop();
                el.innerHTML += `
                <div class="flex items-center justify-between bg-blue-50 p-1 rounded border border-blue-100 mb-1">
                    <div class="flex items-center gap-2 overflow-hidden">
                        <div class="w-4 h-4 rounded-full border border-black/10" style="background:${card.borderColor}"></div>
                        <span class="text-xs truncate max-w-[100px] font-bold text-blue-900" title="${card.img}">${displayName}</span>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="loadFromLibrary(${idx})" class="text-[10px] bg-white border border-gray-300 px-1 rounded hover:bg-gray-100" title="Carica">‚úèÔ∏è</button>
                        <button onclick="removeFromLibrary(${idx})" class="text-[10px] bg-red-100 text-red-600 border border-red-200 px-1 rounded hover:bg-red-200" title="Elimina">üóëÔ∏è</button>
                    </div>
                </div>`;
            });
            document.getElementById('lib-count').innerText = library.length;
        }

        function printLibrary() {
            if (library.length === 0) {
                alert("La libreria √® vuota! Aggiungi prima delle carte.");
                return;
            }
            // Populate Print Area
            const pa = document.getElementById('print-area');
            pa.innerHTML = '';
            library.forEach(card => {
                pa.innerHTML += getCardHTML(card);
            });
            window.print();
        }

        // ACTIONS
        function updateImg(val) { state.img = val; render(); }
        function updateGray(val) { state.gray = parseInt(val); render(); }
        function updateCoins(val) { state.coins = parseInt(val); render(); }
        function updateBorderColor(val) { state.borderColor = val; render(); }

        function addColorReq() {
            const type = document.getElementById('add-color-select').value;
            const existing = state.colors.find(c => c.type === type);
            if (existing) existing.count++;
            else state.colors.push({ type, count: 1 });
            render();
        }
        function updateColorCount(idx, val) {
            state.colors[idx].count = parseInt(val);
            render();
        }
        function removeColor(idx) { state.colors.splice(idx, 1); render(); }

        function exportConfig() {
            const json = JSON.stringify(state, null, 2);
            navigator.clipboard.writeText(json).then(() => alert('Configurazione JSON copiata negli appunti!'));
        }

        // EXPOSE GLOBAL FUNCTIONS (Required for inline onClick handlers with type="module")
        window.render = render;
        window.addToLibrary = addToLibrary;
        window.removeFromLibrary = removeFromLibrary;
        window.loadFromLibrary = loadFromLibrary;
        window.printLibrary = printLibrary;
        window.updateImg = updateImg;
        window.updateGray = updateGray;
        window.updateCoins = updateCoins;
        window.updateBorderColor = updateBorderColor;
        window.addColorReq = addColorReq;
        window.updateColorCount = updateColorCount;
        window.removeColor = removeColor;
        window.exportConfig = exportConfig;

        // LISTENERS
        document.getElementById('img-select').addEventListener('change', (e) => updateImg(e.target.value));
        document.getElementById('custom-img').addEventListener('input', (e) => {
            if (e.target.value) updateImg(e.target.value);
            else updateImg(document.getElementById('img-select').value);
        });
        document.getElementById('req-gray').addEventListener('input', (e) => updateGray(e.target.value));
        document.getElementById('reward-coins').addEventListener('input', (e) => updateCoins(e.target.value));
        const bcp = document.getElementById('border-color-picker');
        if (bcp) bcp.addEventListener('input', (e) => updateBorderColor(e.target.value));

        // INIT
        initImages();
        render();
        renderLibraryList();
    </script>
</body>

</html>